# 판단(Judgment)

`목차`

* [개요](#개요)
* [경로 계획](#경로-계획)
* [경로 궤적](#경로-궤적)
* [경로 추적](#경로-추적)

## 개요

센서를 통해 주변을 인지한 후 어떻게 움직여야 하는지 판단하는 부분

- [경로 계획](./path%20planning)

## 경로 계획

- 차량이 장애물을 회피하면서 목표지점까지 최적의 경로로 도달하게 하는 기술
  - 안전한 경로 혹은 최적화된 경로를 고려해야함
- 전역(Global)경로계획, 지역(Local)경로계획으로 나뉨


- 전역 경로 계획
  - 지도에 기반하여 경로를 자율적으로 생성
  - 주행 기록을 이용한 전역 경로 생성
    - 직접 주행하여 나온 차량의 위치 좌표를 기록하였다가 그대로 다시 주행하는 방법
    - 기록된 차량의 위치정보 하나하나가 웨이 포인트가 됨
  - 다익스트라 알고리즘을 사용하기도 함
    - 다양한 네비게이션 시스템에서 사용되는 기초적인 경로탐색 알고리즘
    - 구현 방법은 [이곳](https://github.com/ii200400/IT_Skill_Question/tree/master/CS/Algorithm#1-dijkstra-algorithm-%EB%8B%A4%EC%9D%B5%EC%8A%A4%ED%8A%B8%EB%9D%BC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98)으로 대체

이미 이전에 정리하였으니 [그것](https://github.com/ii200400/IT_Skill_Question/tree/master/CS/Algorithm#1-dijkstra-algorithm-%EB%8B%A4%EC%9D%B5%EC%8A%A4%ED%8A%B8%EB%9D%BC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98)으로 대체한다.

- 지역 경로 계획
    - 지도 정보로부터 나와 있지 않은 예기치 못한 장애물이나 움직이는 장애물에 대해 여러 가지 센서를 이용하여 장애물을 회피하는 경로를 재생성

## 경로 궤적

경로 계획에 따라 차선 변경이나 경로를 따라가기 위한 궤적이 필요하다. 이 때 3차 곡선을 사용한다. 사용하는 이유는 다음과 같다.

- 1차 함수 궤적은 실재로 사용하기 힘듦
    - 차선 변경이 시작되는 순간과 완료되는 순간에 큰 각도의 변화를 요구하기 때문
    - <img src="https://user-images.githubusercontent.com/19484971/188302479-854b8216-6deb-448c-93c3-3418177588a8.png" width=300>
- 3차 함수 곡선이 적합
    - 1차 함수 궤적보다 훨씬 적은 순각 각도 변화량
    - 안정적인 차선 변경
    - <img src="https://user-images.githubusercontent.com/19484971/188302968-0469cdfd-cde3-4ab7-ac7d-1b6353ade3bd.jpg" width=300>
    > < 경로 생성 - 3차 함수 궤적 >

[논문](https://d-nb.info/1108045847/34)을 통해서 곡률이 있는 차선에 대한 차선 변경법도 있으나 어려워서 생략한다.

<img src="https://user-images.githubusercontent.com/19484971/191668046-27e231bf-05a6-48d9-b678-3aafd2ae8122.png" width=500>

Map P(x, y)와 Q(x, y) 점을 Local P(u, v)와 Local Q(u, v)로 바꿀때 참고한 사진이다. 여기서 Map은 맵 좌표계를, Local은 P점을 기준으로 하는 로컬 좌표계를 의미한다.

1. 현재 주행하는 차선의 한 점을 시작점으로 하고 이동할 차선의 한 점을 끝점으로 한다. (당연히 끝점이 차량에서 더 멀어야 한다.)
2. 시작점을 기준으로 끝점의 좌표를 계산한다. (시작점은 (0,0)이 된다.)
3. 아래의 식을 참고하여 4개의 상수(a0, a1, a2, a3)를 계산한다.   
   
참고로 위의 식에서는 P점을 빼주었지만 P를 기준으로 좌표를 변경했기 때문에(P의 좌표가 (0, 0)이 되어) 꼭 빼줄 필요는 없다.
4. 가로와 세로축(u와 v)에 대해서 위의 식으로 시작점부터 끝점까지의 궤적을 만드는 경로를 만든다. 여기서 경로의 간격은 임의로 정해도 된다.

- v에 값을 넣어 u를 찾을 수 있으며 두 식을 토대로 경로를 만들 수 있다.
    - 예를 들어 1의 간격으로 경로를 만들고 싶다면 (U(1), 1), (U(2), 2)의 방식으로 경로를 만들면 된다.
    - a3v^3이라고 적혀있지만 필자는 편의상 F(u) = a3u^3 + a2u^2 + ... 과 같은 함수를 만들어 사용하였다. (축이 햇갈린다, 개인적으로는 u와 v의 설명이 뒤집힌 것 같다.)
- Qu는 점 Q에서 P기준 좌표계의 u축 좌표를 의미한다.
- initial/final Conditions는 추측하기로.. 시작점과 끝점을 잇는 아래와 같은 조건을 만족하는 3차함수를 만들려고 하기 때문에 존재하는 것 같다.
    - 3차 함수는 (0, 0)을 지남 (U(0) = 0)
    - 3차 함수에 (Qv, Qu)을 지남 (U(Qv) = Qu)
    - 3차 함수의 (0, 0)점에서의 기울기는 0 (U'(0) = 0)
    - 3차 함수의 (Qv, Qu)점에서의 기울기는 0 (U'(Qv) = 0)

- 사실 명세서에서는 아래의 식을 참고하려고 하였으나, 초기조건에 위배되는 상수 계산식이 쓰여있어 위와 같이 자체적으로 계산하여 상수식을 만들었다.
    - <img src="https://user-images.githubusercontent.com/19484971/191667801-cd082de7-6991-47d6-9505-1317a9ec2260.png" width=300>
    - `U(0) = 0` 이고 `U'(0) = 0` 이라면 `a0 = 0`, `a1 = 0`이여야 한다. 그런데 `a0 = Qu`라고 적혀있다.

## 경로 추적

경로를 추종하는 방법은 여러가지가 있으나, 대표적으로 `Pure pursuit guidance`가 있다.

- Pure pursuit guidance
    - `path tracking algorithm(경로 추적 알고리즘)` 중 하나
    - 경로 위의 한 점을 원호를 그리며 추적하는 알고리즘
    - 자동차의 기구학과 전방주시거리(Look Ahead Distance)라는 파라미터를 가지고 조향각을 간단하게 계산
    - 실제 자동차 모델(Ackerman geometry)을 단순화 한 Bicycle 모델을 사용
    - 자세한 내용을 [MathWorks](https://kr.mathworks.com/help/robotics/ug/pure-pursuit-controller.html)에서 찾아볼 수 있다.
        - 대충 전방주시거리를 너무 멀리하면 조향이 느려지고 너무 가깝게 하면 과한 조향으로 궤적을 따라가지 못한다는 내용이 있다.

<img src="https://user-images.githubusercontent.com/19484971/188305260-43d53167-2ddd-4693-8700-dab1fd65b501.png" width=600>

`전방주시거리`라는 단어를 설명해주시지 않고 진행하셔서 처음에는 이미지의 변수가 어떤 의미인지 몰랐다;
